// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

/// Define los roles de usuario en el sistema
enum Role {
  ADMIN
  STUDENT
}

enum RaffleStatus {
  DRAFT // Borrador, aún no activa
  ACTIVE // Activa, aceptando ventas
  FINISHED // Finalizada, esperando sorteo
  DRAWN // Sorteada, con ganador
  CANCELLED // Cancelada
}

enum TicketStatus {
  PENDING // Reservado pero no pagado
  PAID // Pagado y confirmado
  ASSIGNED // ASIGnado
}

/// Define el estado de un pago/recibo
enum PaymentStatus {
  PENDING // Pago iniciado pero no completado
  COMPLETED // Pago exitoso
  FAILED // Pago fallido
}

/// Modelo para los Colegios
model School {
  id        String   @id @default(cuid())
  name      String   @unique
  address   String?
  createdAt DateTime @default(now())

  // Relaciones
  users User[]
  rooms Room[]
}

/// Modelo para las Secciones (ej: "5to Año A")
model Room {
  id        String   @id @default(cuid())
  name      String // Ej: "5to A"
  createdAt DateTime @default(now())

  // Relaciones
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  users User[]

  @@unique([name, schoolId]) // Una sección "5to A" solo puede existir una vez por colegio
}

/// Modelo para Usuarios (Admin y Student)
model User {
  id        String   @id @default(cuid())
  email     String?  @unique
  username  String?  @unique
  name      String?
  password  String // Guardar siempre el hash, no el texto plano
  role      Role     @default(ADMIN)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  schoolId String?
  school   School? @relation(fields: [schoolId], references: [id], onDelete: Restrict)

  roomId        String?
  room          Room?     @relation(fields: [roomId], references: [id], onDelete: SetNull)
  // Relaciones con Rifas
  invoices      Invoice[]
  createdRaffle Raffle[]  @relation("RaffleOrganizer") // Solo para Admins
  tickets       Ticket[]

  // Relaciones con Eventos
  organizedEvents   Event[]               @relation("EventOrganizer") // Solo para Admins
  eventTickets      EventTicket[]         @relation("AssignedEventTickets") // Tickets vendidos por este admin
  receivedTransfers EventTicketTransfer[] @relation("TransferTo") // Tickets recibidos en transferencias
  sentTransfers     EventTicketTransfer[] @relation("TransferFrom") // Tickets enviados en transfer
  eventSoldTickets  EventTicket[]         @relation("TicketSeller") // Tickets vendidos por este admin
}

/// Modelo para las Rifas
model Raffle {
  id          String       @id @default(cuid())
  title       String
  description String?
  prize       String // Descripción del premio
  ticketPrice Decimal // Usar Decimal para dinero
  status      RaffleStatus @default(DRAFT)
  drawDate    DateTime? // Fecha del sorteo
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relaciones
  organizerId String // El ID del admin que la creó
  organizer   User   @relation("RaffleOrganizer", fields: [organizerId], references: [id])

  ticketsSold Ticket[]

  // Relación con el ganador
  winnerTicketId String? @unique // El ID del ticket ganador
  winner         Ticket? @relation("WinningTicket", fields: [winnerTicketId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

/// Modelo para los Tickets
model Ticket {
  id        String       @id @default(cuid())
  number    Int // El número del ticket
  status    TicketStatus @default(PENDING)
  createdAt DateTime     @default(now())

  // Relaciones
  raffleId String
  raffle   Raffle @relation(fields: [raffleId], references: [id], onDelete: Cascade) // Si se borra la rifa, se borran los tickets

  ownerName  String?
  ownerPhone String?

  invoiceId String?
  invoice   Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull) // Si se borra el recibo, el ticket queda sin recibo

  // Relación para saber si este ticket es el ganador
  winnerRaffle Raffle? @relation("WinningTicket")
  userId       String?
  user         User?   @relation(fields: [userId], references: [id])

  // Un número de ticket solo puede existir una vez POR RIFA
  @@unique([raffleId, number])
  @@index([raffleId])
}

/// Modelo para Recibos (Pagos)
model Invoice {
  id String @id @default(cuid())

  // Montos
  totalAmount Decimal // Monto Total (Este será el total en BsS o USD, según la lógica del frontend)

  // Campos de Divisas/Tasa
  amountBss Decimal? // Monto específico en BsS (obligatorio si el método es Pago Móvil/Transferencia)
  amountUsd Decimal? // Monto específico en USD (usado para efectivo)
  bcvRate   Decimal?

  // Soportes de Pago
  paymentMethod String? // Ej: "Efectivo USD", "Transferencia", "Pago Móvil"
  reference     String? // Referencia del pago o número de transacción
  proofUrl      String? // URL o Path del archivo/imagen del comprobante de pago subido

  status PaymentStatus @default(PENDING) // PENDING (para revisión), APPROVED, REJECTED

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  userId String
  user   User   @relation(fields: [userId], references: [id])

  tickets      Ticket[]
  eventTickets EventTicket[]
}

/// Eventos creados por un admin
model Event {
  id          String   @id @default(cuid())
  title       String
  type        String // Ej: "Concierto", "Obra de Teatro"
  description String?  @default("N/A")
  location    String? // Ej: "El Patio"
  date        DateTime // Fecha del evento
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organizerId String
  organizer   User   @relation("EventOrganizer", fields: [organizerId], references: [id])

  ticketTypes EventTicketType[]
  tickets     EventTicket[]
}

model EventTicket {
  id        String       @id @default(cuid())
  code      String       @unique // Código del ticket (similar al number)
  status    TicketStatus @default(PENDING)
  createdAt DateTime     @default(now())

  // Tipo de ticket: General / VIP
  ticketTypeId String
  ticketType   EventTicketType @relation(fields: [ticketTypeId], references: [id], onDelete: Cascade)

  // Relación con evento
  eventId String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  // Estudiante asignado (puede ser null si todavía no hay dueño)
  studentId String?
  student   User?   @relation("AssignedEventTickets", fields: [studentId], references: [id], onDelete: SetNull)

  // Quién vendió el ticket
  sellerId String?
  seller   User?   @relation("TicketSeller", fields: [sellerId], references: [id], onDelete: SetNull)

  // Datos del comprador final
  ownerName  String?
  ownerPhone String?

  // Relación al recibo de pago
  invoiceId String?
  invoice   Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  transfers EventTicketTransfer[]
}

model EventTicketType {
  id        String   @id @default(cuid())
  name      String // Ej: "General", "VIP"
  price     Decimal // Precio por unidad
  createdAt DateTime @default(now())

  // Relación con el Event
  eventId String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  tickets EventTicket[]
}

// Registro histórico de intercambios
model EventTicketTransfer {
  id       String      @id @default(cuid())
  ticketId String
  ticket   EventTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  fromId String?
  from   User?   @relation("TransferFrom", fields: [fromId], references: [id])

  toId String
  to   User   @relation("TransferTo", fields: [toId], references: [id])

  createdAt DateTime @default(now())
}
